<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EntertainHub | Reproductor</title>

</head>

<body>
    <div class="reproductor-wrapper">
        <header class="responsive-header">
            <h1 (click)="irHome()">EntertainHub</h1>

            <div class="perfil-bar">
                <span class="perfil-nombre">üë§ {{ perfilNombre }}</span>
                <div class="botones-header">
                    <button (click)="cambiarPin()">Cambiar PIN</button>
                    <button (click)="volverAPerfiles()">Cambiar Perfil</button>
                    <button (click)="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>
        </header>
        <!-- Overlay para cambio de PIN -->
        <!-- Overlay para cambio de PIN -->
        <div class="pin-overlay" *ngIf="mostrarOverlayPin">
            <div class="pin-modal">
                <h2>Cambiar PIN</h2>

                <!-- Paso 1: PIN actual -->
                <div *ngIf="!pinValidado">
                    <label>PIN actual</label>
                    <div class="pin-inputs">
                        <input maxlength="1" [(ngModel)]="pinActual[0]" (input)="handleInput(pinActual, 0, $event)" />
                        <input maxlength="1" [(ngModel)]="pinActual[1]" (input)="handleInput(pinActual, 1, $event)" />
                        <input maxlength="1" [(ngModel)]="pinActual[2]" (input)="handleInput(pinActual, 2, $event)" />
                        <input maxlength="1" [(ngModel)]="pinActual[3]" (input)="handleInput(pinActual, 3, $event)" />
                    </div>
                    <div class="botones">
                        <button (click)="validarPin()" [disabled]="cargandoPin">
                            <span *ngIf="cargandoPin" class="spinner"></span>
                            <span *ngIf="!cargandoPin">Validar</span>
                        </button>
                        <button class="cancelar" (click)="cerrarOverlay()">Cancelar</button>
                    </div>
                </div>

                <!-- Paso 2: Nuevo PIN -->
                <div *ngIf="pinValidado">
                    <label>Nuevo PIN</label>
                    <div class="pin-inputs">
                        <input maxlength="1" [(ngModel)]="pinNuevo[0]" (input)="handleInput(pinNuevo, 0, $event)" />
                        <input maxlength="1" [(ngModel)]="pinNuevo[1]" (input)="handleInput(pinNuevo, 1, $event)" />
                        <input maxlength="1" [(ngModel)]="pinNuevo[2]" (input)="handleInput(pinNuevo, 2, $event)" />
                        <input maxlength="1" [(ngModel)]="pinNuevo[3]" (input)="handleInput(pinNuevo, 3, $event)" />
                    </div>
                    <div class="botones">
                        <button (click)="guardarPin()" [disabled]="cargandoGuardar">
                            <span *ngIf="cargandoGuardar" class="spinner"></span>
                            <span *ngIf="!cargandoGuardar">Guardar</span>
                        </button>
                        <button class="cancelar" (click)="cerrarOverlay()">Cancelar</button>
                    </div>
                </div>

                <p *ngIf="mensajePin" [ngStyle]="{ color: esErrorPin ? '#f44336' : '#4caf50' }">
                    {{ mensajePin }}
                </p>

            </div>
        </div>

        <div class="media-section-grid" *ngIf="contenido">
            <!-- Contenido principal -->
            <div class="media-render">
                <h2 class="titulo">{{ contenido.titulo }}</h2>
                <p class="descripcion">{{ contenido.descripcion }}</p>
                <div *ngIf="esAudio()" class="audio-view">
                    <img class="portada-audio" [src]="contenido.portada" />
                    <audio controls (play)="onMediaPlay()" (ended)="onMediaEnded()"
                        style="width: 100%; max-width: 800px; border-radius: 6px;">
                        <source [src]="contenido.url" type="audio/mpeg" />
                    </audio>
                </div>

                <video *ngIf="esVideo()" controls class="video-view" (play)="onMediaPlay()" (ended)="onMediaEnded()">
                    <source [src]="contenido.url" type="video/mp4" />
                </video>
                <div class="acciones">
                    <a>
                        <button class="descargar" *ngIf="!esDescargado"
                            (click)="descargarContenido()">Descargar</button>
                        <span *ngIf="esDescargado" class="descargado">Descargado</span>

                    </a>
                </div>
            </div>

            <div>
                <div>
                    <div class="acciones" *ngIf="!playlist">
                        <button class="descargar" (click)="abrirOverlayPlaylist()">A√±adir a Playlist</button>
                    </div>

                    <!-- Overlay selector de playlist -->
                    <div class="pin-overlay" *ngIf="mostrarOverlayPlaylist">
                        <div class="playlist scrollable-modal">
                            <h2>Selecciona una Playlist</h2>

                            <div class="playlist-list">
                                <p *ngIf="mensajeAgregar" style="color: #4caf50; margin-bottom: 10px;">
                                    {{ mensajeAgregar }}
                                </p>

                                <div class="playlist-item" (click)="abrirOverlayCrearPlaylist()">
                                    <img src="https://cdn-icons-png.flaticon.com/512/1828/1828817.png" />
                                    <div class="info">
                                        <strong>‚ûï Nueva Playlist</strong>
                                        <p>Crear una nueva lista con este contenido</p>
                                    </div>
                                </div>

                                <div class="playlist-item" *ngFor="let p of playlistss"
                                    [class.disabled]="cargandoPlaylistId !== null"
                                    (click)="!cargandoPlaylistId && agregarAPlaylistExistente(p.id)">
                                    <img [src]="p.portada || 'https://via.placeholder.com/80x80?text=No+Img'" />

                                    <div class="info">
                                        <strong>{{ p.nombre }}</strong>
                                        <div *ngIf="cargandoPlaylistId === p.id" class="spinner-inline"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="botones">
                                <button class="cancelar" (click)="cerrarOverlayPlaylist()">Cancelar</button>
                            </div>
                        </div>
                    </div>

                    <!-- Overlay crear nueva playlist -->
                    <div class="pin-overlay" *ngIf="mostrarOverlayCrearPlaylist">
                        <div class="playlist">
                            <h2>Nueva Playlist</h2>
                            <input [(ngModel)]="nombreNuevaPlaylist" placeholder="Nombre de la playlist" />
                            <p *ngIf="mensajePlaylist" style="color: #4caf50; margin-bottom: 10px;">
                                {{ mensajePlaylist }}
                            </p>

                            <div class="botones">
                                <button (click)="crearNuevaPlaylist()" [disabled]="cargandoCrearPlaylist">
                                    <span *ngIf="cargandoCrearPlaylist" class="spinner"></span>
                                    <span *ngIf="!cargandoCrearPlaylist">Crear</span>
                                </button>
                                <button class="cancelar" (click)="cerrarOverlayCrearPlaylist()">Cancelar</button>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="playlist-side" *ngIf="playlist?.length">
                    <h3>üéß Playlist: {{playlistNombre}}</h3>
                    <div class="playlist-list">
                        <div class="playlist-item" *ngFor="let item of playlist"
                            (click)="irAContenido(item.id, item.titulo, true)">
                            <img [src]="item.portada" />

                            <div class="info">
                                <div class="fila-superior">
                                    <strong>{{ item.titulo }}</strong>

                                    <!-- √çcono de borrar -->
                                    <span class="icono-borrar" title="Borrar de la playlist"
                                        (click)="eliminarDePlaylistActual(item.id, $event)">
                                        ‚ùå
                                    </span>
                                </div>

                                <p>{{ item.descripcion }}</p>
                                <span class="badge" [ngClass]="item.tipo === 'audio' ? 'audio' : 'video'">
                                    {{ item.tipo.toUpperCase() }}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>




        <ng-container *ngIf="!modoOffline && recomendaciones?.length">
            <div class="section-title">‚ú® Tambi√©n te puede interesar</div>
            <div class="carousel">
                <div class="item" *ngFor="let r of recomendaciones" (click)="irAContenido(r.id, r.titulo)">
                    <img [src]="r.portada" />
                    <div class="overlay">{{ r.titulo }}</div>
                    <span class="audio-badge" *ngIf="r.tipo === 'audio'">AUDIO</span>
                    <span class="video-badge" *ngIf="r.tipo === 'video'">VIDEO</span>
                </div>
            </div>
        </ng-container>

        <ng-container *ngIf="modoOffline">
            <div class="section-title">üéß Contenido descargado (Offline)</div>
            <div class="carousel">
                <div class="item" *ngFor="let c of contenidosDescargados" (click)="irAContenido(c.id, c.titulo)">
                    <img [src]="c.portada" />
                    <div class="overlay">‚úî {{ c.titulo }}</div>
                    <span class="audio-badge" *ngIf="c.tipo === 'audio'">AUDIO</span>
                    <span class="video-badge" *ngIf="c.tipo === 'video'">VIDEO</span>
                </div>
            </div>
        </ng-container>

    </div>

</body>